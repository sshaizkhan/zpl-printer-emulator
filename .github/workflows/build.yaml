name: Build & Release

on:
  push:
    branches:
      - master
    tags:
      - v*
  pull_request:

jobs:
  test:
    name: Test (${{ matrix.os }} - ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ macOS-latest, ubuntu-latest, windows-latest ]
        arch: [ x64 ]
        include:
          - os: macOS-latest
            arch: arm64
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 16.x
          cache: yarn
      - name: Install (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i to install dependencies..."
            yarn --network-timeout 100000 && break || sleep 10
          done
      - name: Install (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          for ($i = 1; $i -le 5; $i++) {
            Write-Host "Attempt $i to install dependencies..."
            yarn --network-timeout 100000
            if ($LASTEXITCODE -eq 0) { break }
            Start-Sleep -Seconds 10
          }
      - name: Create fake contributors
        uses: 1arp/create-a-file-action@0.3
        with:
          path: 'static'
          file: 'contributors.json'
          content: "[]"
#      - name: lint
#        run: yarn lint
#      - name: test
#        run: yarn test:ci
#      - name: Coveralls
#        if: matrix.os == 'ubuntu-latest'
#        uses: coverallsapp/github-action@2
#        with:
#          github-token: ${{ secrets.GITHUB_TOKEN }}
  build:
    needs: test
    name: Build (${{ matrix.os }} - ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # Build for supported platforms
        # https://github.com/electron/electron-packager/blob/ebcbd439ff3e0f6f92fa880ff28a8670a9bcf2ab/src/targets.js#L9
        # 32-bit Linux unsupported as of 2019: https://www.electronjs.org/blog/linux-32bit-support
        os: [ macOS-latest, ubuntu-latest, windows-latest ]
        arch: [ x64, arm64 ]
        include:
          - os: windows-latest
            arch: ia32
          - os: ubuntu-latest
            arch: armv7l
        # Publishing artifacts for multiple Windows architectures has
        # a bug which can cause the wrong architecture to be downloaded
        # for an update, so until that is fixed, only build Windows x64
        exclude:
          - os: windows-latest
            arch: arm64

    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 16.x
          cache: yarn
#      - name: Set MacOS signing certs
#        if: matrix.os == 'macOS-latest'
#        run: chmod +x tools/add-macos-cert.sh && ./tools/add-macos-cert.sh
#        env:
#          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
#          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
#      - name: Set Windows signing certificate
#        if: matrix.os == 'windows-latest'
#        continue-on-error: true
#        id: write_file
#        uses: timheuer/base64-to-file@v1
#        with:
#          fileName: 'win-certificate.pfx'
#          encodedString: ${{ secrets.WINDOWS_CODESIGN_P12 }}
      - name: Extract version from tag
        if: startsWith(github.ref, 'refs/tags/')
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      - name: Update package.json version (Linux/macOS)
        if: startsWith(github.ref, 'refs/tags/') && runner.os != 'Windows'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" package.json
          rm -f package.json.bak
          echo "Updated package.json version to $VERSION"
      - name: Update package.json version (Windows)
        if: startsWith(github.ref, 'refs/tags/') && runner.os == 'Windows'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $content = Get-Content package.json -Raw
          $content = $content -replace '"version": "[^"]*"', "`"version`: `"$VERSION`""
          Set-Content package.json -Value $content -NoNewline
          Write-Host "Updated package.json version to $VERSION"
      - name: Install (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i to install dependencies..."
            yarn --network-timeout 100000 && break || sleep 10
          done
      - name: Install (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          for ($i = 1; $i -le 5; $i++) {
            Write-Host "Attempt $i to install dependencies..."
            yarn --network-timeout 100000
            if ($LASTEXITCODE -eq 0) { break }
            Start-Sleep -Seconds 10
          }
      - name: Make
        if: startsWith(github.ref, 'refs/tags/')
        run: yarn make --arch=${{ matrix.arch }}
        env:
#          APPLE_ID: ${{ secrets.APPLE_ID }}
#          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          WINDOWS_CODESIGN_FILE: ${{ steps.write_file.outputs.filePath }}
#          WINDOWS_CODESIGN_PASSWORD: ${{ secrets.WINDOWS_CODESIGN_PASSWORD }}
      - name: Archive production artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-${{ matrix.arch }}
          path: |
            out/make/**/*.deb
            out/make/**/*.dmg
            out/make/**/*setup*.exe
            out/make/**/*.nupkg
            out/make/**/*.rpm
            out/make/**/*.zip
            out/make/**/RELEASES
            out/make/**/*portable*.exe
          retention-days: 1
          if-no-files-found: ignore

  release:
    needs: build
    # Allow release even if some builds failed (e.g., macOS network issues)
    if: always() && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare release files
        run: |
          mkdir -p release-files
          # Copy setup installers (architecture-specific, keep all)
          find artifacts -type f -name "*setup*.exe" -exec cp {} release-files/ \;
          # Copy other platform files (deb, dmg, rpm, zip)
          find artifacts -type f \( -name "*.deb" -o -name "*.dmg" -o -name "*.rpm" -o -name "*.zip" \) -exec cp {} release-files/ \;
          # Handle duplicates: portable exe, RELEASES, .nupkg (prefer x64, keep only one)
          PORTABLE=$(find artifacts -type f -name "*portable*.exe" | grep -E "(x64|windows-latest-x64)" | head -1)
          if [ -z "$PORTABLE" ]; then
            PORTABLE=$(find artifacts -type f -name "*portable*.exe" | head -1)
          fi
          [ -n "$PORTABLE" ] && cp "$PORTABLE" release-files/
          
          RELEASES=$(find artifacts -type f -name "RELEASES" | grep -E "(x64|windows-latest-x64)" | head -1)
          if [ -z "$RELEASES" ]; then
            RELEASES=$(find artifacts -type f -name "RELEASES" | head -1)
          fi
          [ -n "$RELEASES" ] && cp "$RELEASES" release-files/
          
          NUPKG=$(find artifacts -type f -name "*.nupkg" | grep -E "(x64|windows-latest-x64)" | head -1)
          if [ -z "$NUPKG" ]; then
            NUPKG=$(find artifacts -type f -name "*.nupkg" | head -1)
          fi
          [ -n "$NUPKG" ] && cp "$NUPKG" release-files/
      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: true
          files: release-files/*
          fail_on_unmatched_files: false
